<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Durable Agents</title>
    <link rel="stylesheet" href="static/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #gradient-canvas {
            width: 100%;
            height: 100%;
            --gradient-color-1: #FDA110;
            --gradient-color-2: #444CE7;
            --gradient-color-3: #211B4E;
            --gradient-color-4: #D300DB;
        }

        .content-section {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 485px;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0 24px;
            box-sizing: border-box;
        }

        .temporal-logo {
            display: block;
            margin: 80px auto 0;
            width: 48px;
            height: 48px;
        }

        .main-heading {
            color: #FFF;
            text-align: center;
            font-family: 'Aeonik', sans-serif;
            font-size: 2.375rem;
            font-style: normal;
            font-weight: 300;
            line-height: 2.25rem;
            margin-top: 1.5rem;
        }

        .subtitle {
            color: #F8FAFC;
            text-align: center;
            font-family: 'Aeonik', sans-serif;
            font-size: 0.875rem;
            font-style: normal;
            font-weight: 400;
            line-height: 1.25rem;
            margin-top: 0.34rem;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 2rem;
            max-height: calc(100vh - 450px);
            overflow-y: auto;
            padding-bottom: 1rem;
        }

        .message {
            display: flex;
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            display: flex;
            padding: 0.6875rem 1rem;
            justify-content: center;
            align-items: center;
            gap: 0.625rem;
            font-family: 'Aeonik', sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            max-width: 346px;
        }

        .message-bubble.bot {
            border-radius: 0 1rem 1rem 1rem;
            border: 1px solid #E4E4E7;
            background: #FFF;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.10), 0 1px 2px -1px rgba(0, 0, 0, 0.10);
            color: #000;
        }

        .message-bubble.user {
            display: flex;
            padding: 0.625rem 1rem;
            justify-content: center;
            align-items: center;
            gap: 0.625rem;
            border-radius: 1rem 0 1rem 1rem;
            background: #444CE7;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.10), 0 1px 2px -1px rgba(0, 0, 0, 0.10);
            color: #FFF;
        }

        .spinner-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .spinner {
            width: 1.6485rem;
            height: 1.6485rem;
            transform: rotate(156.169deg);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(156.169deg);
            }
            to {
                transform: rotate(516.169deg);
            }
        }

        .researching-text {
            font-family: 'Aeonik', sans-serif;
            font-size: 0.875rem;
            font-style: normal;
            font-weight: 400;
            line-height: 1.25rem;
            background: linear-gradient(90deg, #E4E4E7 0%, #FFF 50%, #E4E4E7 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .input-container {
            position: absolute;
            bottom: 40px;
            left: 24px;
            right: 24px;
        }

        .input-wrapper {
            position: relative;
        }

        .user-input {
            display: flex;
            height: 3rem;
            padding: 0.25rem 3rem 0.25rem 1.5rem;
            align-items: center;
            flex: 1 0 0;
            width: 100%;
            border-radius: 62499.9375rem;
            border: 1px solid #444CE7;
            background: rgba(255, 255, 255, 0.90);
            box-shadow: 0 0 0 0.094px rgba(63, 63, 70, 0.03);
            font-family: 'Aeonik', sans-serif;
            font-size: 1rem;
            outline: none;
        }

        .user-input::placeholder {
            color: #465A78;
            font-family: 'Aeonik', sans-serif;
            font-size: 0.875rem;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
        }

        .submit-button {
            display: flex;
            width: 2.5rem;
            height: 2.5rem;
            justify-content: center;
            align-items: center;
            position: absolute;
            right: 0.25rem;
            top: 0.25rem;
            border-radius: 1048575rem;
            background: #444CE7;
            border: none;
            cursor: pointer;
        }

        .submit-button svg {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <canvas id="gradient-canvas"></canvas>
    
    <div class="content-section">
        <!-- Temporal Logo -->
        <svg class="temporal-logo" width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32.4154 15.5846C31.2802 7.09512 28.4175 0 24 0C19.5949 0 16.7198 7.09512 15.5846 15.5846C7.09511 16.7198 0 19.5825 0 24C0 28.4051 7.09511 31.2802 15.5846 32.4154C16.7198 40.9049 19.5825 48 24 48C28.4051 48 31.2802 40.9049 32.4154 32.4154C40.9049 31.2802 48 28.4175 48 24C48 19.5825 40.9049 16.7075 32.4154 15.5846ZM15.3131 29.9229C7.18149 28.7506 2.43084 26.0607 2.43084 23.9877C2.43084 21.9147 7.16915 19.2247 15.3131 18.0524C15.128 20.0144 15.0416 22.0134 15.0416 23.9877C15.0416 25.962 15.128 27.9733 15.3131 29.9229ZM24 2.41851C26.073 2.41851 28.763 7.15682 29.9352 15.3008C27.9733 15.1157 25.9743 15.0293 24 15.0293C22.0257 15.0293 20.0267 15.128 18.0648 15.3008C19.237 7.16916 21.927 2.41851 24 2.41851ZM32.6869 29.9229C32.292 29.9846 30.6386 30.1697 30.2314 30.219C30.1943 30.6386 29.9969 32.2797 29.9352 32.6746C28.763 40.8062 26.073 45.5568 24 45.5568C21.927 45.5568 19.237 40.8185 18.0648 32.6746C18.0031 32.2797 17.818 30.6262 17.7686 30.219C17.5835 28.2941 17.4602 26.2211 17.4602 23.9877C17.4602 21.7542 17.5712 19.6936 17.7686 17.7563C19.6936 17.5712 21.7666 17.4478 24 17.4478C26.2334 17.4478 28.2941 17.5589 30.2314 17.7563C30.6509 17.7933 32.292 17.9907 32.6869 18.0524C40.8185 19.2247 45.5691 21.9147 45.5691 23.9877C45.5691 26.0607 40.8185 28.7506 32.6869 29.9229Z" fill="#F8FAFC"/>
        </svg>
        
        <!-- Main Heading -->
        <h1 class="main-heading">Build Durable Agents</h1>
        <p class="subtitle">Powered by Temporal</p>

        <!-- Chat Container -->
        <div class="chat-container" id="chatContainer">
            <!-- Bot Message -->
            <div class="message bot">
                <div class="message-bubble bot">
                    Hey there, what would you like to research?
                </div>
            </div>
        </div>

        <!-- Spinner (hidden by default) -->
        <div class="spinner-container" id="spinnerContainer" style="display: none;">
            <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 35 35" fill="none">
                <g clip-path="url(#clip0_18_726)">
                    <path d="M8.34424 21.388C7.50043 19.4773 7.28314 17.3486 7.72353 15.3068C8.16393 13.2651 9.23938 11.4151 10.7958 10.0222C12.3522 8.6292 14.3096 7.76469 16.3875 7.55256C18.4654 7.34042 20.5571 7.79155 22.3629 8.84127C24.1686 9.891 25.5957 11.4854 26.4396 13.3961C27.2835 15.3067 27.5009 17.4355 27.0606 19.4773C26.6203 21.519 25.5449 23.369 23.9886 24.762C22.4323 26.1551 20.4749 27.0197 18.397 27.2319" stroke="#00C950" stroke-width="2.19796" stroke-linecap="round" stroke-linejoin="round"/>
                </g>
                <defs>
                    <clipPath id="clip0_18_726">
                        <rect width="26.3755" height="26.3755" fill="white" transform="translate(34.7835 24.127) rotate(156.169)"/>
                    </clipPath>
                </defs>
            </svg>
            <span class="researching-text">Researching...</span>
        </div>

        <!-- Input Container -->
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" class="user-input" placeholder="Reply...">
                <button class="submit-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M3.33301 7.99992L7.99967 3.33325L12.6663 7.99992" stroke="white" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 12.6666V3.33325" stroke="white" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { NeatGradient } from 'https://cdn.jsdelivr.net/npm/@firecms/neat@0.3.0/+esm';

        const neat = new NeatGradient({
            ref: document.getElementById('gradient-canvas'),
            colors: [
                {
                    color: '#FDA110',
                    enabled: true,
                },
                {
                    color: '#444CE7',
                    enabled: true,
                },
                {
                    color: '#211B4E',
                    enabled: true,
                },
                {
                    color: '#D300DB',
                    enabled: true,
                },
                {
                    color: '#f5e1e5',
                    enabled: false,
                },
            ],
            speed: 1.5,
            horizontalPressure: 3,
            verticalPressure: 5,
            waveFrequencyX: 2,
            waveFrequencyY: 3,
            waveAmplitude: 5,
            shadows: 0,
            highlights: 2,
            colorBrightness: 1,
            colorSaturation: 7,
            wireframe: false,
            colorBlending: 7,
            backgroundColor: '#003FFF',
            backgroundAlpha: 1,
            grainScale: 2,
            grainSparsity: 0,
            grainIntensity: 0.5,
            grainSpeed: 1,
            resolution: 1,
        });
    </script>

    <script src="static/api-client.js"></script>
    <script>
        // ============================================
        // PRODUCTION MODE - Connects to FastAPI backend
        // Backend URL - update this for your environment
        // ============================================
        const API_BASE_URL = 'http://localhost:8234';
        
        const client = new ResearchClient(API_BASE_URL);
        
        // ============================================
        // UI Logic
        // ============================================
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.querySelector('.user-input');
        const submitButton = document.querySelector('.submit-button');
        const spinnerContainer = document.getElementById('spinnerContainer');
        
        let workflowId = null;
        let currentQuestionIndex = 0;

        // Add message to chat with animation
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${isUser ? 'user' : 'bot'}`;
            bubbleDiv.textContent = text;
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Show/hide spinner
        function showSpinner(visible) {
            spinnerContainer.style.display = visible ? 'flex' : 'none';
        }

        // Handle form submission
        async function handleSubmit() {
            const query = userInput.value.trim();
            if (!query) return;

            // Add user message (animates in as indigo right-aligned bubble)
            addMessage(query, true);
            userInput.value = '';

            // Show spinner
            showSpinner(true);

            try {
                if (!workflowId) {
                    // First submission - start new research workflow
                    const result = await client.startResearch(query);
                    workflowId = result.workflow_id;
                } else {
                    // Subsequent submissions - answer clarification question
                    await client.submitAnswer(query, workflowId, currentQuestionIndex);
                }
                
                // Poll for next status
                pollStatus();
                
            } catch (error) {
                console.error('Error:', error);
                showSpinner(false);
                addMessage('Sorry, something went wrong. Please try again.');
            }
        }

        // Poll for workflow status
        async function pollStatus() {
            try {
                const status = await client.getStatus(workflowId);
              
                if (
                  (status.status === 'awaiting_clarifications' && status.current_question) ||
                  status.status === 'collecting_answers') {
                    currentQuestionIndex = status.current_question_index;

                    // Hide spinner, show clarification question
                    showSpinner(false);
                    addMessage(status.current_question);
                } else if (status.status === 'researching') {
                    // Keep spinner visible, continue polling
                    setTimeout(pollStatus, 1000);
                    
                } else if (status.status === 'completed') {
                    // Research complete - get result and redirect
                    showSpinner(false);
                    const result = await client.getResult(workflowId);
                    
                    // Store result in sessionStorage for success page
                    sessionStorage.setItem('researchResult', JSON.stringify(result));
                    sessionStorage.setItem('workflowId', workflowId);
                    
                    console.log("redirecting...");
                    // Redirect to success page
                    window.location.href = 'success';
                    
                } else {
                    // Other states - keep polling
                    setTimeout(pollStatus, 1000);
                }
            } catch (error) {
                console.error('Polling error:', error);
                setTimeout(pollStatus, 2000);
            }
        }

        // Event listeners
        submitButton.addEventListener('click', handleSubmit);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSubmit();
            }
        });
    </script>
</body>
</html>
